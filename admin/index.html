<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin • Super Healthy</title>
<style>
body{font-family:system-ui,Arial;margin:20px;max-width:900px}
input,button,textarea{padding:10px;border:1px solid #ccc;border-radius:10px}
button{cursor:pointer;font-weight:700}
.row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:10px 0}
.muted{color:#666}
textarea{resize:vertical;width:100%}
.pending{background:#fff6e5}
.hidden{display:none}
</style>
</head>
<body>

<h1>Admin</h1>

<!-- LOGIN -->
<div id="login-box">
  <div class="row">
    <input id="password" type="password" placeholder="Admin password" />
    <button onclick="login()">Login</button>
  </div>
  <p id="login-status" class="muted"></p>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel" class="hidden">

<button onclick="logout()" style="margin-bottom:20px;">Logout</button>

<h2>Products</h2>
<div class="row">
  <button onclick="loadProducts()">Load Products</button>
</div>
<div id="list" class="muted">Not loaded yet.</div>

<h3>Add Product</h3>
<div class="row">
  <input id="n" placeholder="name">
  <input id="s" placeholder="slug">
  <input id="p" placeholder="price" type="number" step="0.01">
  <input id="g" placeholder="grams" type="number">
  <input id="c" placeholder="category">
  <input id="i" placeholder="image" style="flex:1">
</div>
<div class="row">
  <textarea id="d" placeholder="description"></textarea>
</div>
<div class="row">
  <button onclick="addProduct()">Add Product</button>
</div>

<h2>Reviews</h2>
<div class="row">
  <button onclick="loadReviews()">Load Reviews</button>
</div>
<div id="reviews-list" class="muted">Not loaded yet.</div>

</div>

<script>
async function login() {
  const password = document.getElementById("password").value.trim();
  if(!password) return alert("Enter password");

  const res = await fetch("/api/admin/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ password }),
    credentials:"include"  // important to send cookie
  });

  const status = document.getElementById("login-status");
  if(res.ok){
    status.textContent = "✅ Logged in";
    document.getElementById("login-box").classList.add("hidden");
    document.getElementById("admin-panel").classList.remove("hidden");
  } else {
    const data = await res.json();
    status.textContent = "❌ " + (data.error || "Login failed");
  }
}

async function logout() {
  await fetch("/api/admin/logout", { method:"POST", credentials:"include" });
  document.getElementById("admin-panel").classList.add("hidden");
  document.getElementById("login-box").classList.remove("hidden");
}

// ---------- PRODUCTS ----------
async function loadProducts() {
  const res = await fetch("/api/admin/products", { credentials:"include" });
  if(!res.ok) return alert("Not authorized");
  const products = await res.json();
  const list = document.getElementById("list");
  list.innerHTML = products.map(p=>`
    <div class="card">
      <b>${p.name}</b> (${p.slug})<br>
      Price: <input id="price-${p.slug}" type="number" value="${p.price||0}">
      Grams: <input id="grams-${p.slug}" type="number" value="${p.grams||0}">
      <div>Description:<br><textarea id="desc-${p.slug}">${p.shortDesc||""}</textarea></div>
      <button onclick="updateProduct('${p.slug}')">Save</button>
      <button onclick="delProduct('${p.slug}')">Delete</button>
    </div>
  `).join("") || "<p>No products</p>";
}

async function updateProduct(slug) {
  const price = Number(document.getElementById(`price-${slug}`).value);
  const grams = Number(document.getElementById(`grams-${slug}`).value);
  const shortDesc = document.getElementById(`desc-${slug}`).value;

  await fetch(`/api/admin/products/${slug}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    credentials:"include",
    body: JSON.stringify({ price, grams, shortDesc })
  });
  loadProducts();
}

async function addProduct() {
  const body = {
    name: n.value.trim(),
    slug: s.value.trim(),
    price: Number(p.value||0),
    grams: Number(g.value||0),
    category: c.value.trim(),
    image: i.value.trim(),
    shortDesc: d.value.trim()
  };
  await fetch("/api/admin/products", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    credentials:"include",
    body: JSON.stringify(body)
  });
  loadProducts();
}

async function delProduct(slug) {
  if(!confirm("Delete "+slug+"?")) return;
  await fetch(`/api/admin/products/${slug}`, { method:"DELETE", credentials:"include" });
  loadProducts();
}

// ---------- REVIEWS ----------
async function loadReviews() {
  const res = await fetch("/api/admin/reviews", { credentials:"include" });
  if(!res.ok) return alert("Not authorized");
  const reviews = await res.json();
  const list = document.getElementById("reviews-list");
  list.innerHTML = reviews.map(r=>`
    <div class="card ${r.approved?"":"pending"}">
      <b>${r.name}</b>
      <p>${r.text}</p>
      ${!r.approved?`<button onclick="approveReview(${r.id})">Approve</button>`:"Approved"}
      <button onclick="deleteReview(${r.id})">Delete</button>
    </div>
  `).join("");
}

async function approveReview(id){
  await fetch(`/api/admin/reviews/${id}/approve`, { method:"PUT", credentials:"include" });
  loadReviews();
}

async function deleteReview(id){
  if(!confirm("Delete review?")) return;
  await fetch(`/api/admin/reviews/${id}`, { method:"DELETE", credentials:"include" });
  loadReviews();
}
</script>

</body>
</html>
